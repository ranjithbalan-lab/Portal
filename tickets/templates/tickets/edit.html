{% extends "dashboard.html"%}

{% block title %}Edit Ticket #{{ ticket.pk }}{% endblock %}

{% block content %}
<div class="w-full p-4 md:p-8 bg-white shadow-xl rounded-lg">
    
    <div class="flex items-center justify-between mb-8 border-b pb-4">
        <a href="{% url 'tickets:home' %}" class="flex items-center space-x-1 py-2 px-4 text-sm font-medium text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition duration-150">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> 
            <span>Back to Ticket List</span>
        </a>

        <h5 class="text-2xl font-bold text-gray-800 flex items-center">
            <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            Edit Support Ticket <span class="ml-2 text-indigo-500">#{{ ticket.pk }}</span>
        </h5>
        <div class="w-1/4"></div> 
    </div>

    {# 1. TARGET THE EDIT VIEW #}
    <form method="POST" action="{% url 'tickets:update' ticket.tk_id %}">
        {% csrf_token %}

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            {# TICKET CATEGORY - Uses logic to select the current value #}
            <div class="flex flex-col">
                <label for="id_tk_category" class="block text-sm font-medium text-gray-700 mb-1">Category <span class="text-red-500">*</span></label>
                <select id="id_tk_category" name="tk_category" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
                    {% for value, label in TICKET_CATEGORY_CHOICES %}
                        <option value="{{ value }}" {% if ticket.tk_category == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            {# TICKET TYPE #}
            <div class="flex flex-col">
                <label for="id_tk_type" class="block text-sm font-medium text-gray-700 mb-1">Ticket Type <span class="text-red-500">*</span></label>
                <select id="id_tk_type" name="tk_type" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
                    {% for value, label in TICKET_TYPE_CHOICES %}
                        <option value="{{ value }}" {% if ticket.tk_type == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            {# TICKET PRIORITY #}
            <div class="flex flex-col">
                <label for="id_tk_priority" class="block text-sm font-medium text-gray-700 mb-1">Priority <span class="text-red-500">*</span></label>
                <select id="id_tk_priority" name="tk_priority" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
                    {% for value, label in TICKET_PRIORITY_CHOICES %}
                        <option value="{{ value }}" {% if ticket.tk_priority == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            {# REQUESTED BY - Added value attribute #}
            <div class="flex flex-col">
                <label for="id_tk_req_by" class="block text-sm font-medium text-gray-700 mb-1">Requested By <span class="text-red-500">*</span></label>
                <input type="text" id="id_tk_req_by" name="tk_req_by" value="{{ ticket.tk_req_by }}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
            </div>
            
            {# CONTACT PHONE #}
            <div class="flex flex-col">
                <label for="id_tk_req_phone" class="block text-sm font-medium text-gray-700 mb-1">Contact Phone<span class="text-red-500">*</span></label>
                <input type="text" id="id_tk_req_phone" name="tk_req_phone" value="{{ ticket.tk_req_phone }}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
            </div>

            {# CONTACT EMAIL #}
            <div class="flex flex-col">
                <label for="id_tk_req_email" class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                <input type="email" id="id_tk_req_email" name="tk_req_email" value="{{ ticket.tk_req_email|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
            </div>

            {# SYSTEM/UNIT AFFECTED #}
            <div class="flex flex-col">
                <label for="id_tk_unit" class="block text-sm font-medium text-gray-700 mb-1">System/Unit Affected</label>
                <input type="text" id="id_tk_unit" name="tk_unit" value="{{ ticket.tk_unit|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
            </div>
            
            {# TARGET DUE DATE - Note: format for HTML date input is YYYY-MM-DD #}
            <div class="flex flex-col">
                <label for="id_tk_due_date" class="block text-sm font-medium text-gray-700 mb-1">Target Due Date</label>
                <input type="date" id="id_tk_due_date" name="tk_due_date" value="{{ ticket.tk_due_date|date:'Y-m-d' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
            </div>
                {# 86: Corrected Status Field #}
            <div class="flex flex-col">
                <label for="id_tk_status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="id_tk_status" name="tk_status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
                    {% for value, label in TICKET_STATUS %}
                        <option value="{{ value }}" {% if ticket.tk_status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex flex-col">
                {# 1. Changed Label to match intent #}
                <label for="id_tk_assigned_to" class="block text-sm font-medium text-gray-700 mb-1">Allocated Person</label>
                
                {# 2. Changed name and id to match the actual person field #}
                <select id="id_tk_assigned_to" name="tk_assigned_to" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
                    {% for value, label in TICKET_ALLOCATED_PERSON %}
                        {# 3. Ensure the 'if' condition checks the correct field (tk_assigned_to) #}
                        <option value="{{ value }}" {% if ticket.tk_assigned == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
           {% if ticket.tk_attachment %}
                <div class="mt-4 p-4 border rounded-lg bg-gray-50">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Attached Evidence:</p>
                    
                    {% if ".jpg" in ticket.tk_attachment.url|lower or ".png" in ticket.tk_attachment.url|lower %}
                        <img src="{{ ticket.tk_attachment.url }}" class="max-w-md h-auto rounded-lg shadow-sm border">
                    {% else %}
                        <a href="{{ ticket.tk_attachment.url }}" class="text-blue-500 underline" download>
                            Download Document
                        </a>
                    {% endif %}
                </div>
            {% endif %}
            </div>
       <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            {# SUBJECT - Left Side #}
            <div class="flex flex-col">
                <label for="id_tk_subject" class="block text-sm font-medium text-gray-800 mb-1">Subject <span class="text-red-500">*</span></label>
                <input type="text" id="id_tk_subject" name="tk_subject" value="{{ ticket.tk_subject }}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
            </div>
            
            {# DETAILED DESCRIPTION - Right Side #}
            <div class="flex flex-col">
                <label for="id_tk_description" class="block text-sm font-medium text-gray-700 mb-1">Detailed Description</label>
                <textarea id="id_tk_description" name="tk_description" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">{{ ticket.tk_description }}</textarea>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-6">
            {# Rootcause - Left Side #}
            <div class="flex flex-col">
                <label for="id_tk_root_cause" class="block text-sm font-medium text-gray-800 mb-1">Root Cause <span class="text-red-500">*</span></label>
                <input type="text" id="id_tk_root_cause" name="tk_root_cause" value="{{ ticket.tk_root_cause }}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">
            </div>
            
            {# Preventive Action - Right Side #}
            <div class="flex flex-col">
                <label for="id_tk_preventive_action" class="block text-sm font-medium text-gray-700 mb-1">Preventive Action</label>
                <textarea id="id_tk_preventive_action" name="tk_preventive_action" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">{{ ticket.tk_preventive_action }}</textarea>
            </div>
            {# Corrective Action Action - Right Side #}
            <div class="flex flex-col">
                <label for="id_tk_corrective_action" class="block text-sm font-medium text-gray-700 mb-1">Preventive Action</label>
                <textarea id="id_tk_corrective_action" name="tk_corrective_action" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2.5">{{ ticket.tk_corrective_action }}</textarea>
            </div>
        </div>

        <div class="mt-10 pt-6 border-t flex justify-end space-x-4">
            <button type="submit" class="flex items-center space-x-2 py-2.5 px-6 text-sm font-medium text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span>Save Changes</span>
            </button>
            <a href="{% url 'tickets:home' %}" class="flex items-center space-x-2 py-2.5 px-6 text-sm font-medium text-white bg-gray-500 rounded-lg shadow-sm hover:bg-gray-600 transition duration-150">
                <span>Cancel</span>
            </a>
        </div>
    </form>
</div>
{% endblock %}